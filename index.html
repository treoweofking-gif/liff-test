<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç¤¾å†…ãƒãƒ¼ã‚¿ãƒ«</title>
</head>
<body>
  <h1>ç¤¾å†…ãƒãƒ¼ã‚¿ãƒ«</h1>
  <div id="message" style="white-space: pre-wrap;">èµ·å‹•ä¸­...</div>

<ul id="menu" style="display:none;">
  <li><button id="btn-leave">ğŸ“„ ä¼‘æš‡ç”³è«‹</button></li>
  <li><button id="btn-ot">â± æ®‹æ¥­ç”³è«‹</button></li>
  <li><button id="btn-addr">ğŸ  ä½æ‰€å¤‰æ›´å±Š</button></li>
</ul>

  <!-- â˜…ã“ã‚ŒãŒç„¡ã„ã¨ liff ãŒå­˜åœ¨ã—ã¾ã›ã‚“ -->
  <script>
  async function init() {
    const el = document.getElementById("message");
    const setMsg = (t) => { el.textContent = t; };
    const addMsg = (t) => { el.textContent += "\n" + t; };

    try {
      if (typeof liff === "undefined") {
        setMsg("ã‚¨ãƒ©ãƒ¼: LIFF SDK ãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ï¼ˆliff ãŒæœªå®šç¾©ï¼‰");
        return;
      }

      setMsg("1) LIFF åˆæœŸåŒ–ä¸­...");
      await liff.init({ liffId: "2008866562-UCmyNOOE" });

      addMsg("2) isLoggedIn=" + liff.isLoggedIn());
      if (!liff.isLoggedIn()) {
        addMsg("3) æœªãƒ­ã‚°ã‚¤ãƒ³â†’loginã¸é·ç§»ã—ã¾ã™");
        liff.login();
        return;
      }

      addMsg("4) getProfileä¸­...");
      const profile = await liff.getProfile();
      const userId = profile.userId;
      addMsg("5) userId=" + userId);

      addMsg("6) /api/me å‘¼ã³å‡ºã—ä¸­...");
      const res = await fetch(
        "https://liff-api.onrender.com/api/me?line_user_id=" + userId
      );
      const data = await res.json();

      addMsg("7) exists=" + data.exists);
      addMsg("API raw:\n" + JSON.stringify(data, null, 2));

      if (data.exists === true) {
        const params = new URLSearchParams(location.search);
        const p = params.get("p");

        // ä½æ‰€å¤‰æ›´ãƒšãƒ¼ã‚¸ï¼ˆãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ p=address ã§æ¥ãŸã¨ãï¼‰
        if (p === "address") {
          document.getElementById("menu").style.display = "none";
          addMsg("8) èªè¨¼OKï¼šä½æ‰€å¤‰æ›´ãƒ•ãƒ­ãƒ¼");
          addMsg("ä½æ‰€å¤‰æ›´ã¨ãªã£ãŸé‹è»¢å…è¨±è¨¼ã¾ãŸã¯ä½æ°‘ç¥¨ã®å†™çœŸã‚’é€ã£ã¦ãã ã•ã„ã€‚");

          const btn = document.createElement("button");
          btn.textContent = "ä½æ‰€å¤‰æ›´ã‚’é–‹å§‹ï¼ˆãƒˆãƒ¼ã‚¯ã¸é€ä¿¡ï¼‰";
          btn.onclick = async () => {
            await liff.sendMessages([{ type: "text", text: "ä½æ‰€å¤‰æ›´ã‚’ç”³è«‹ã—ã¾ã™" }]);
            liff.closeWindow();
          };
          document.body.appendChild(btn);

          return; // ã“ã“ã§æ­¢ã‚ã‚‹ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ã¯å‡ºã•ãªã„ï¼‰
        }

        // é€šå¸¸ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
        document.getElementById("menu").style.display = "block";

        document.getElementById("btn-leave").onclick = () => {
          document.getElementById("message").textContent = "ä¼‘æš‡ç”³è«‹ï¼ˆæ¬¡ã§ãƒ•ã‚©ãƒ¼ãƒ åŒ–ã—ã¾ã™ï¼‰";
          document.getElementById("menu").style.display = "none";
        };

        document.getElementById("btn-ot").onclick = () => {
          document.getElementById("message").textContent = "æ®‹æ¥­ç”³è«‹ï¼ˆæ¬¡ã§ãƒ•ã‚©ãƒ¼ãƒ åŒ–ã—ã¾ã™ï¼‰";
          document.getElementById("menu").style.display = "none";
        };

        document.getElementById("btn-addr").onclick = () => {
          document.getElementById("message").textContent = "ä½æ‰€å¤‰æ›´ã¯ä¸‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰é–‹å§‹ã—ã¦ãã ã•ã„";
          document.getElementById("menu").style.display = "none";
        };

        addMsg("8) èªè¨¼OKï¼šç”³è«‹æ›¸ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º");
      } else {
        addMsg("8) æœªç™»éŒ²ï¼šç®¡ç†éƒ¨ã¸é€£çµ¡ã—ã¦ãã ã•ã„");
      }

    } catch (e) {
      setMsg("ã‚¨ãƒ©ãƒ¼: " + (e && e.message ? e.message : e));
    }
  }

  init();
</script>
</body>
</html>
